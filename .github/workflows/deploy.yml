name: Build & Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - 'DEPLOYMENT.md'

env:
  IMAGE: ghcr.io/uswapexchange/zero

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: '1.23.6'

      - name: Verify zero dependencies
        run: |
          if grep -q 'require' go.mod; then
            echo "ERROR: go.mod has external dependencies â€” this project uses stdlib only"
            exit 1
          fi

      - name: Run tests
        run: go test -short -v ./...

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build and push Docker image
        id: docker
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE }}:latest
            ${{ env.IMAGE }}:${{ github.sha }}
          build-args: |
            COMMIT_HASH=${{ github.sha }}
            BUILD_TIME=${{ github.event.head_commit.timestamp }}
            BUILD_LOG_URL=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Build and push Tor image
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: ./tor
          push: true
          tags: |
            ${{ env.IMAGE }}-tor:latest
            ${{ env.IMAGE }}-tor:${{ github.sha }}

      - name: Deploy to Coolify
        env:
          HAS_COOLIFY: ${{ secrets.COOLIFY_API_TOKEN }}
        if: env.HAS_COOLIFY != ''
        run: |
          curl -f -s \
            "${{ secrets.COOLIFY_API_URL }}/api/v1/deploy?uuid=${{ secrets.COOLIFY_APP_UUID }}&force=true" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}"

      - name: Update DEPLOYMENT.md
        run: |
          GOMOD_HASH=$(sha256sum go.mod | cut -d' ' -f1)
          cat > DEPLOYMENT.md << EOF
          # Deployment Record

          | Field | Value |
          |-------|-------|
          | Commit | [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |
          | Build Time | ${{ github.event.head_commit.timestamp }} |
          | Image | \`${{ env.IMAGE }}:${{ github.sha }}\` |
          | Image Digest | \`${{ steps.docker.outputs.digest }}\` |
          | CI Build Log | [View](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | go.mod Hash | \`${GOMOD_HASH}\` |

          ---
          *Auto-generated by CI. See [git history](https://github.com/${{ github.repository }}/commits/main/DEPLOYMENT.md) for full deployment log.*
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add DEPLOYMENT.md
          git diff --cached --quiet || git commit -m "deploy: update DEPLOYMENT.md [skip ci]"
          git push
